---
title: "Conditional Nelson-Aalen and Aalen Johansen Estimation "
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Bla bla bla 

## 1. Markov model with independent censoring

We start out with a simple Markov model:

\begin{align*}
\frac{\mathrm{d}\Lambda(t)}{\mathrm{d}t}=\lambda(t)=\frac{1}{1+\frac{1}{2}t}
\begin{pmatrix}
-2 & 1& 1 \\
2 & -3 & 1 \\
0 & 0 & 0 
\end{pmatrix}
\end{align*}

```{r}
library(AalenJohansen)

set.seed(2)

jump_rate <- function(i, t, u){
  if(i == 1){
    2 / (1+1/2*t)
  } else if(i == 2){
    3 / (1+1/2*t)
  } else{
    0
  }
}

mark_dist <- function(i, s, v){
  if(i == 1){
    c(0, 1/2, 1/2)
  } else if(i == 2){
    c(2/3, 0, 1/3)
  } else{
    0
  } 
}

lambda <- function(t){
  A <- matrix(c(2/(1+1/2*t)*mark_dist(1, t, 0), 3/(1+1/2*t)*mark_dist(2, t, 0), rep(0, 3)),
              nrow = 3, ncol = 3, byrow = TRUE)
  diag(A) <- -rowSums(A)
  A
}
```

We simulate $1,000$ independent realizations subject to independent right-censoring with distribution $\text{Unif}(0,5)$:

```{r}
n <- 1000

c <- runif(n, 0, 5)

sim <- list()
for(i in 1:n){
  sim[[i]] <- sim_path(sample(1:2, 1), rates = jump_rate, dists = mark_dist,
                       tn = c[i], bs = c(2*c[i], 3*c[i], 0))
}
```

The degree of censoring is

```{r}
sum(c == unlist(lapply(sim, FUN = function(z){tail(z$times, 1)}))) / n
```


We fit the classic Nelson--Aalen and Aalen-Johansen estimators:

```{r}
fit <- aalen_johansen(sim)
```

For illustrative purposes, we plot lines of the true (full) and estimated (dashed) $\Lambda_{21}$ and $p_2$:

```{r, fig.align = 'center', fig.height = 3, fig.width = 6}
v1 <- unlist(lapply(fit$Lambda, FUN = function(L) L[2,1]))
v0 <- fit$t
p <- unlist(lapply(fit$p, FUN = function(L) L[2]))
P <- unlist(lapply(prodint(0, 5, 0.01, lambda), FUN = function(L) (c(1/2, 1/2, 0) %*% L)[2]))

par(mfrow = c(1, 2))
par(mar = c(2.5, 2.5, 1.5, 1.5))

plot(v0, v1, type = "l", lty = 2, xlab = "", ylab = "", main = "Hazard")
lines(v0, 4*log(1+1/2*v0))
plot(v0, p, type = "l", lty = 2, xlab = "", ylab = "", main = "Probability")
lines(seq(0, 5, 0.01), P)
```

## 2. Markov model with independent censoring and covariates


\begin{align*}
\frac{\mathrm{d}\Lambda(t|x)}{\mathrm{d}t}=\lambda(t|x)=\frac{1}{1+x\cdot t}\cdot \begin{pmatrix}
-3 & 1& 1 & 1\\
2 & -5 & 1 & 2\\
1 & 1& -4 & 2\\
0 & 0& 0 & 0
\end{pmatrix}
\end{align*}

```{r}
1+2+2
```

## 3. Markov model with dependent censoring and covariates


\begin{align*}
\frac{\mathrm{d}\Lambda(t|x)}{\mathrm{d}t}=\lambda(t|x)=\frac{1}{1+x\cdot t}\cdot \begin{pmatrix}
-3 & 1& 1 & 1\\
2 & -5 & 1 & 2\\
1 & 1& -4 & 2\\
0 & 0& 0 & 0
\end{pmatrix}
\end{align*}

```{r}
1+2+2
```

## 4. Semi-Markov model with independent censoring


\begin{align*}
\frac{\mathrm{d}\Lambda(t|x)}{\mathrm{d}t}=\lambda(t|x)=\frac{1}{1+x\cdot t}\cdot \begin{pmatrix}
-3 & 1& 1 & 1\\
2 & -5 & 1 & 2\\
1 & 1& -4 & 2\\
0 & 0& 0 & 0
\end{pmatrix}
\end{align*}

```{r}
1+2+2
```
